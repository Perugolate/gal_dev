# Table of contents

- [Dependencies](#dependencies)
- [Read data](#read-data)
- [Fit model and extract results](#fit-model-and-extract-results)
  - [Check GALME gene](#check-galme-gene)
  - [Perform contrasts](#perform-contrasts)
  - [Subset LRT results using contrast results](#subset-lrt-results-using-contrast-results)
- [Some visualisations](#some-visualisations)
  - [DE gene heatmap](#de-gene-heatmap)
  - [Sample-to-sample heatmap](#sample-to-sample-heatmap)
  - [Munge variance-stabilized results for clustering](#munge-variance-stabilized-results-for-clustering)
  - [Cluster in python with sklearn](#cluster-in-python-with-sklearn)
  - [Plot the clusters](#plot-the-clusters)
  - [Plot PCs by stage](#plot-pcs-by-stage)
- [GOs](#gos)
- [Miscellaneous](#miscellaneous)

# Dependencies

```r
library("DESeq2")
library("magrittr")
library("RColorBrewer")
library("gplots")
library("cowplot")
library("tidyr")
library("dplyr")
library("BiocParallel")
library("plotrix")
library("mseapca")
library("readr")
library("GOstats")
library("GSEABase")
```

# Read data

```r
# Remove library 34 - contaminated with a yeast library with the same index.
countData <- read_tsv("gene_counts.tsv.gz", col_names=TRUE) %>% dplyr::select(-X34)
rownames(countData) <- countData$gene
countData <- dplyr::select(countData, -gene) %>% round
# No rowSums filter because it eliminates less than 10% rows.
# Read in sample descriptions and remove library 34 metadata.
colData <- read_tsv("meta", col_names=TRUE) %>% filter(sample != "X34")
# Create a factor "stage" with one level for each of six developmental stages.
colnames(colData) <- c("", "stage")
colData$stage <- factor(colData$stage, levels=c("one", "two", "three", "five", 
						"six", "seven"))
# Re-level so that wandering stage ("one") is the base level.
colData$stage <- relevel(colData$stage, ref="one")
colData$batch <- readLines("batch") %>% as.factor
```

# Fit model and extract results

```r
dds <- DESeqDataSetFromMatrix(countData = countData, colData = colData, 
			      design = ~ stage + batch)
dds <- DESeq(dds, test = "LRT", full = ~ stage + batch, reduced = ~ batch, 
	     parallel = TRUE, fitType = "local")
res <- results(dds, alpha = 0.05, tidy = TRUE)
```
## Check GALME gene

There seems to be a batch effect for early stages that can cause lysozyme GALME gene (Swiss-Prot accession P82174) to be excluded when `batch` is not fitted.

```r
p82174 <- plotCounts(dds, gene = "c86535_g1", intgroup = c("stage", "batch"),
		     returnData = TRUE)
ggplot(p82174, aes(x = stage, y = count, color = batch)) + geom_point(size = 5) +
       scale_y_log10() + ggtitle("P82174 expression")
```

![P82174 expression plot](https://github.com/Perugolate/gal_dev/blob/master/p82174.png)

So, check that *p* values for P82174 (c86535_g1) have not been set to NA.

```r
subset(res, row == "c86535_g1") # check if p value for P82174 is set to NA.
```
## Perform contrasts

List IDs of genes which change at least 2-fold from all possible contrasts.
```r
# Get significant results from LRT test.
resSig <- subset(res, padj < 0.05)
# Create a data frame of all possible contrasts.
contr <- combn(unique(as.character(colData$stage)), 2) %>% 
  as.data.frame(stringsAsFactors = FALSE)
# Take the ids of genes with absolute(log2FoldChanges) > 1 from all contrasts.
foldchanges <- lapply(names(contr), function(x) {
  results(dds, alpha = 0.05, parallel = TRUE, contrast = c("stage",contr[,x])) %>%
  subset(abs(log2FoldChange) > 1) %>% rownames
})
# Concatenate and deduplicate the gene names.
foldchangesN <- unlist(foldchanges) %>% unique
```

## Subset LRT results using contrast results

Use ids to find genes which are significant in the LRT test:
```r
# Use the gene names to pull out the significant genes from the LRT.
# Gives genes which have an absolute(log2FoldChanges) > 1 & padj <= 0.05.
resLfc <- subset(resSig, row %in% foldchangesN)
```

# Some visualisations

Stabilize variance for clustering and PCA.
```r
rld <- rlogTransformation(dds, blind = FALSE)
# reorder factor levels for PCA plot legend
rld@colData@listData$stage <- factor(rld@colData@listData$stage, 
				     levels=c("one", "two", "three", "five", 
					      "six", "seven"))
```

## DE gene heatmap

Note `plotPCA` calls prcomp. Scaling makes no difference (I checked) since values are already scaled by the transformation.

```r
# Use all genes instead of top 500 by row variance.
plotPCA(rld, ntop = nrow(rld), intgroup = "stage")
```

![PCA plot](https://github.com/Perugolate/gal_dev/blob/master/pca.png)

```r
rldMat <- assay(rld)
distsRL <- dist(t(rldMat))
hc <- hclust(distsRL, method = 'mcquitty')
# Take the transformed data for genes which are DE.
res_rld <- subset(rldMat, rownames(rldMat) %in% resLfc$row)
# Seperate object for heatmap since colnames cause problems later.
res_rldHm <- res_rld 
colnames(res_rldHm) <- colData$stage
hmcol <- colorRampPalette(brewer.pal(9, "GnBu"))(100)
# This is very slow when Rowv=TRUE.
# Refactor with pheatmap - needs a lot of RAM
heatmap.2(res_rldHm, col = hmcol, Rowv = TRUE, Colv = as.dendrogram(hc),
          scale = "none", dendrogram = "both", trace = "none",
	  labRow = FALSE, key = TRUE)
```

## Sample-to-sample heatmap

```r
mat <- as.matrix(distsRL)
rownames(mat) <- colnames(mat) <- colData$stage
heatmap.2(mat, Rowv = as.dendrogram(hc), symm = TRUE, trace = "none", col = rev(hmcol),
	  margin = c(8, 8))
```

![sample-sample heatmap](https://github.com/Perugolate/gal_dev/blob/master/samsam.png)

## Munge variance-stabilized results for clustering

```r
res_rld <- as.data.frame(res_rld)
res_rld$gene <- rownames(res_rld)
# Add stage information to transformed data.
colnames(res_rld) <- c(paste(colData[,1] , colData$stage, sep="_"), "gene")
# Reshape into long format.
rsvt <- gather(res_rld, stage, expression, -gene)
rsvt$stage <- as.character(rsvt$stage)
rsvt <- separate(rsvt, stage, c("sample", "stage"))
by_genExp <- group_by(rsvt, gene, stage)
# don't use devExp itself so will replace with a large chain
devExpCl <- summarize(by_genExp, exp=mean(expression), sd=sd(expression))
devExpCw <- dplyr::select(devExpCl, gene, stage, exp) %>% spread(stage, exp) %>%
  dplyr::select(gene, one, two, three, five, six, seven)
# nrow(res_rld)*6 == nrow(devExp) == nrow(devExpCw)*6
rownames(devExpCw) <- devExpCw$gene
```

Write out for clustering in `python` with `scikit-learn` while dropping gene.
```r
write.table(dplyr::select(devExpCw, -gene), file="genes", quote=FALSE, row.names=FALSE,
	    sep=",")
```

## Cluster in python with sklearn

```python
import numpy as np
from sklearn import mixture

# Load data without the headers.
foo = np.loadtxt(open("genes", "r"), delimiter=",", skiprows=1)

n_components=40 # an upper bound for no. of components.
lowest_bic = np.infty
bic = []
cv_types = ['spherical', 'tied', 'diag', 'full']
for cv_type in cv_types:
    # Fit a Dirichlet process mixture of Gaussians.
    dpgmm = mixture.DPGMM(n_components=n_components, covariance_type=cv_type)
    dpgmm.fit(foo)
    bic.append(dpgmm.bic(foo))
    if bic[-1] < lowest_bic:
        lowest_bic = bic[-1]
        best_dpgmm = dpgmm

# Predict the labels for the model with lowest BIC.
labels = best_dpgmm.predict(foo)
# Write the labels out for use in R.
np.savetxt("labels", labels, fmt="%s")
```

## Plot the clusters

```r
devExpCw$cluster <- scan("labels", what="integer")
# remove devExpCl above and replace with longer chain straight to devExpCw
devExpCl2 <- gather(devExpCw, stage, expression, -gene, -cluster) %>% 
  group_by(cluster, stage) %>%
  summarize(exp=mean(expression), ci=std.error(expression)*1.96)
# Plot cluster means
ggplot(devExpCl2, aes(x=stage, y=exp, group=cluster)) + geom_line() + 
	facet_wrap(~cluster, ncol=5, scales="free_y") + ylab("Expression") +
	xlab("Stage") + ggtitle("Gene expression across larval-pupal moult") + 
	geom_ribbon(aes(ymin=exp-ci, ymax=exp+ci), alpha=0.2)
```

## Plot PCs by stage

```r
pca2 <- prcomp(t(dplyr::select(res_rld, -gene)), scale=FALSE)
pca2x <- as.data.frame(pca2$x)
# add sensibly ordered stage factor.
pca2x$stage <- rld@colData@listData$stage
# determine which PCs to keep from scree plot (here 4).
plot(pca2$sdev^2, type="b")
# summarize and then plot each PC by stage
pca2sum <- dplyr::select(pca2x, PC1, PC2, PC3, PC4, stage) %>%
  gather(PC, value, -stage) %>%
  group_by(PC, stage) %>%
  summarize(val=mean(value), ci=std.error(value)*1.96)
ggplot(pca2sum, aes(x=stage, y=val, group=PC)) + geom_line() + 
	facet_wrap(~PC, ncol=5, scales="free_y") + ylab("Expression") + 
	xlab("Stage") + ggtitle("Gene expression across larval-pupal moult") + 
	geom_ribbon(aes(ymin=val-ci, ymax=val+ci), alpha=0.2)
```

Determine significantly loading genes.
```r
D <- data.frame(rownames(res_rld), dplyr::select(res_rld, -gene))
A <- pca_scaled(D)
L <- A[["factor.loading"]]
colnames(L) <- c("gene", paste("PC", c(1:43), sep=""))
Ll <- gather(L, pc, loading, -gene)
Q <- A[["q.value"]]
colnames(Q) <- c("gene", paste("PC", c(1:43), sep=""))
Ql <- gather(Q, pc, q, -gene)
QLl <- merge(Ql, Ll, by=c("gene", "pc"), all=TRUE)
sqll <- filter(QLl, q < 0.05)
# for each gene keep the highest (absolute) loading which is significant.
rsqll <- filter(sqll, q < 0.05) %>% group_by(gene) %>% 
  filter(rev(rank(abs(loading)))==1)
# add column describing cluster.
rsqll$sign <- sign(rsqll$loading)
rsqll$sign <- gsub("-1", "negative", rsqll$sign)
rsqll$sign <- gsub("1", "positive", rsqll$sign)
rsqll$cluster <- paste(rsqll$pc, rsqll$sign, sep="_")
# subset the rlogged counts and combine with pca data.
wExp <- subset(devExpCw, devExpCw$gene %in% rsqll$gene)
wExpPca <- merge(dplyr::select(wExp, -cluster), rsqll, by="gene")
# plot mean expression stage for each cluster.
dplyr::select(wExpPca, -pc, -loading, -sign, -q) %>% 
  gather(stage, expression, -gene, -cluster) %>% group_by(cluster, stage) %>% 
  summarize(exp=mean(expression), ci=std.error(expression)*1.96) %>% 
  ggplot(aes(x=stage, y=exp, group=cluster)) + geom_line() + 
	  facet_wrap(~cluster, ncol=6, scales="free_y") + 
	  geom_ribbon(aes(ymin=exp-ci, ymax=exp+ci), alpha=0.2)
```

## Contamination

```r
df1 <- readLines(pipe("grep Saccharomyces refseq/outfmt6.all.uniq | cut -f1-2 -d'_'"))
sigSac <- subset(devExpCw, devExpCw$gene %in% df1)
dplyr::select(sigSac, -cluster) %>% gather(stage, exp, -gene) %>% group_by(stage) %>% 
  summarize(expression=mean(exp)) %>% ggplot(aes(x=stage, y=expression)) + 
  geom_point()
```

# GOs

```r
gol <- read.table("gos_long", header=FALSE, sep="\t")
colnames(gol) <- c("frame.go_id","frame.EVIDENCE","frame.gene_id")
goFrame <- GOFrame(gol)
goAllFrame <- GOAllFrame(goFrame)
gsc <- GeneSetCollection(goAllFrame, setType = GOCollection())
universe <- as.character(gol$frame.gene_id) # this is the all of the GO terms
goTest <- function(x) {
    result <- summary(hyperGTest(GSEAGOHyperGParams(name="up",
                      geneSetCollection=gsc, geneIds=x, universeGeneIds=universe,
                      ontology="BP", pvalueCutoff=0.05, conditional=TRUE,
                      testDirection="over")))
    return(result)
}
write.table(goTest(down30m), file="cd30m.tsv", sep="\t", quote=FALSE, row.names=FALSE)
```

# Miscellaneous

Plot for grant:

```r
ggplot(lys, aes(x = stage, y = count)) + geom_point(size = 5, alpha = 0.5) +
       scale_y_log10(breaks = c(1, 10,100,1000,10000, 100000)) +
       xlab("Developmental stage") + ylab("Lysozyme gene expression (normalized count)") +
       scale_x_discrete(labels=c("I", "II", "III", "V", "VI", "VII"))
```

