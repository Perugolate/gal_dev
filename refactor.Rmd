# Table of contents

- [Dependencies](#dependencies)
- [Read data](#read-data)
- [Fit model and extract results](#fit-model-and-extract-results)
 * [Check GALME gene](#check-galme-gene)
 * [Perform contrasts](#perform-contrasts)

# Dependencies

```{r}
library("DESeq2")
library("magrittr")
library("BiocParallel")
register(MulticoreParam(12)) # use 12 cores.
```

# Read data

```{r}
# Remove library 34 which was contaminated with a yeast library with the same index.
countData <- read.table(gzfile("gene_counts.tsv.gz"), header=TRUE)[,-15] %>% round
# Read in sample descriptions and remove library 34 metadata.
colData <- read.table("meta", header=FALSE)[-15,]
# Create a factor "stage" with one level for each of six developmental stages.
colnames(colData) <- c("", "stage")
colData$stage <- as.factor(colData$stage)
# Re-level so that wandering stage ("one") is the base level.
colData$stage <- relevel(colData$stage, ref="one")
colData$batch <- readLines("batch") %>% as.factor
```

# Fit model and extract results

```{r}
dds <- DESeqDataSetFromMatrix(countData = countData, colData = colData, design = ~ stage + batch)
dds <- DESeq(dds, test="LRT", full = ~ stage + batch, reduced = ~ batch, parallel=TRUE, fitType="local")
res <- results(dds, alpha=0.05, tidy=TRUE)
```
## Check GALME gene

Check that *p* values for lysozyme GALME gene (Swiss-Prot accession P82174) have not been set to NA. There seems to be a batch effect for early stages that can cause it to be excluded when batch is not fitted.
```{r}
edata <- dds@rowData@elementMetadata %>% as.data.frame # get the dispersion outlier data.
rownames(edata) <- rownames(countData)
subset(edata, rownames(edata) %in% "c86535_g1") # check P82174 is dispersion outlier.
subset(res, row=="c86535_g1") # check if p value for P82174 is set to NA.
```
## Perform contrasts

List IDs of genes which change at least 2-fold from all possible contrasts.
```{r}
# Get significant results from LRT test.
resSig <- subset(res, padj < 0.05)
# Create a data frame of all possible contrasts.
contr <- combn(unique(as.character(colData$stage)), 2) %>% as.data.frame(stringsAsFactors=FALSE)
# Take the ids of genes with absolute(log2FoldChanges) > 1 from all possible contrasts.
foldchanges <- lapply(names(contr), function(x) {
results(dds, parallel=TRUE, contrast=c("stage",contr[,x])) %>% subset(abs(log2FoldChange)>1) %>% rownames
})
# Concatenate and deduplicate the gene names.
foldchangesN <- unlist(foldchanges) %>% unique
```
