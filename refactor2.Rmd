LRT between `~ batch`, and `~ stage + batch` has c86535_g1 as DE. Dropping `batch` leads to pvalues for c86535_g1 being set to NA. So I'll keep batch as an effect.

# Dependencies
```{r}
library("DESeq2")
library("magrittr")
library("BiocParallel")
register(MulticoreParam(12)) # use 12 cores.
```

# Read data
```{r}
# Remove library 34 which was contaminated with a yeast library with the same index.
countData <- read.table("matrix.counts.matrix4", header=TRUE)[,-15] %>% round
# Read in sample descriptions and remove library 34 metadata.
colData <- read.table("meta", header=FALSE)[-15,]
# Create a factor "stage" with one level for each of six developmental stages.
colnames(colData) <- c("", "stage")
colData$stage <- as.factor(colData$stage)
# Re-level so that wandering stage ("one") is the base level.
colData$stage <- relevel(colData$stage, ref="one")
colData$batch <- readLines("batch") %>% as.factor
```

# Fit model and extract results
```{r}
dds <- DESeqDataSetFromMatrix(countData = countData, colData = colData, design = ~ stage + batch)
dds <- DESeq(dds, test="LRT", full = ~ stage + batch, reduced = ~ batch, parallel=TRUE, fitType="local")
res <- results(dds, alpha=0.05, tidy=TRUE)
```

Check that the lysozyme GALME (Swiss-Prot accession P82174) has not been excluded. There seems to be a batch effect for early stages that can cause it to be excluded when batch is not fitted.
```{r}
edata <- dds@rowData@elementMetadata %>% as.data.frame # get the dispersion outlier data.
rownames(edata) <- rownames(countData)
subset(edata, rownames(edata) %in% "c86535_g1") # check P82174 is dispersion outlier.
subset(res, row=="c86535_g1") # check if p value for P82174 is set to NA.
```

List IDs of genes which change at least 2-fold from all possible contrasts.
```{r}
# Get significant results from LRT test.
resSig <- subset(res, padj < 0.05)
# Create a data frame of all possible contrasts.
contr <- combn(unique(as.character(colData$stage)), 2) %>% as.data.frame(stringsAsFactors=FALSE)
# Take the ids of genes with absolute(log2FoldChanges) > 1 from all possible contrasts.
foldchanges <- lapply(names(contr), function(x) {
results(dds, parallel=TRUE, contrast=c("stage",contr[,x])) %>% subset(abs(log2FoldChange)>1) %>% rownames
})
# Concatenate and deduplicate the gene names.
foldchangesN <- unlist(foldchanges) %>% unique
```
